<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EV Station Finder</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
        }

        #map {
            height: 100vh;
            width: 100vw;
            z-index: 1;
        }

        .search-container {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            gap: 10px;
            max-width: 500px;
        }

        .search-box {
            flex: 1;
            padding: 15px 20px;
            border: none;
            border-radius: 25px;
            background: white;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            font-size: 16px;
            outline: none;
            transition: all 0.3s ease;
        }

        .search-box:focus {
            box-shadow: 0 6px 30px rgba(0,0,0,0.2);
            transform: translateY(-2px);
        }

        .search-btn {
            padding: 15px 20px;
            border: none;
            border-radius: 25px;
            background: #10b981;
            color: white;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
            min-width: 60px;
        }

        .search-btn:hover {
            background: #059669;
            transform: translateY(-2px);
            box-shadow: 0 6px 30px rgba(0,0,0,0.2);
        }

        .controls {
            position: absolute;
            top: 90px;
            left: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .control-btn {
            padding: 12px;
            border: none;
            border-radius: 50%;
            background: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            cursor: pointer;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            position: relative;
        }

        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(0,0,0,0.2);
        }

        .control-btn:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 60px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1001;
            pointer-events: none;
        }

        .control-btn.active {
            background: #10b981;
            color: white;
        }

        .station-popup {
            max-width: 300px;
            font-family: inherit;
        }

        .station-header {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 8px;
            color: #333;
        }

        .station-info {
            margin-bottom: 6px;
            font-size: 14px;
            color: #666;
        }

        .station-rating {
            color: #ff9800;
            font-weight: bold;
        }

        .station-distance {
            color: #10b981;
            font-weight: bold;
        }

        .station-photos {
            display: flex;
            gap: 5px;
            margin: 10px 0;
            overflow-x: auto;
            max-width: 280px;
        }

        .station-photos::-webkit-scrollbar {
            height: 4px;
        }

        .station-photos::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 2px;
        }

        .station-photos::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 2px;
        }

        .station-photo {
            width: 80px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .station-photo:hover {
            transform: scale(1.1);
        }

        .station-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .action-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 15px;
            background: #10b981;
            color: white;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .action-btn:hover {
            background: #059669;
            transform: translateY(-1px);
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2000;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            display: none;
        }

        .spinner {
            border: 3px solid #e2e8f0;
            border-top: 3px solid #10b981;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results-panel {
            position: absolute;
            right: 20px;
            top: 20px;
            bottom: 20px;
            width: 350px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 30px rgba(0,0,0,0.15);
            z-index: 1000;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }

        .results-header {
            padding: 20px;
            background: #10b981;
            color: white;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
        }

        .results-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .result-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
        }

        .result-item:hover {
            background: #f5f5f5;
        }

        .result-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .result-address {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .result-meta {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .search-container {
                left: 10px;
                right: 10px;
                top: 10px;
            }

            .controls {
                left: 10px;
                top: 70px;
            }

            .results-panel {
                right: 10px;
                left: 10px;
                top: 70px;
                bottom: 10px;
                width: auto;
            }

            .search-box {
                font-size: 16px; /* Prevent zoom on iOS */
            }
        }

        @media (max-width: 480px) {
            .search-container {
                flex-direction: column;
            }

            .search-btn {
                border-radius: 15px;
            }

            .controls {
                flex-direction: row;
                left: 10px;
                right: 10px;
                top: 130px;
                justify-content: center;
            }

            .results-panel {
                top: 180px;
            }
        }

        /* Custom marker styles */
        .ev-marker {
            background: #10b981;
            border: 3px solid white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .user-marker {
            background: #2196F3;
            border: 3px solid white;
            border-radius: 50%;
            width: 15px;
            height: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        /* Route styles */
        .route-info {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1001;
        }

        /* Dark mode styles */
        body.dark-mode {
            background: #0f172a;
            color: #f1f5f9;
        }

        body.dark-mode .search-box {
            background: #1e293b;
            color: #f1f5f9;
            border: 1px solid #334155;
        }

        body.dark-mode .search-box::placeholder {
            color: #94a3b8;
        }

        body.dark-mode .control-btn {
            background: #1e293b;
            color: #f1f5f9;
            border: 1px solid #334155;
        }

        body.dark-mode .search-btn {
            background: #059669;
            color: #ffffff;
            border: 1px solid #047857;
        }

        body.dark-mode .search-btn:hover {
            background: #047857;
        }

        body.dark-mode .control-btn:hover {
            background: #334155;
            border-color: #475569;
        }

        body.dark-mode .control-btn.active {
            background: #059669;
            color: white;
            border-color: #047857;
        }

        body.dark-mode .results-panel {
            background: #1e293b;
            color: #f1f5f9;
            border: 1px solid #334155;
        }

        body.dark-mode .results-header {
            background: #059669;
        }

        body.dark-mode .result-item {
            border-bottom: 1px solid #334155;
        }

        body.dark-mode .result-item:hover {
            background: #334155;
        }

        body.dark-mode .loading {
            background: #1e293b;
            color: #f1f5f9;
            border: 1px solid #334155;
        }

        body.dark-mode .spinner {
            border-color: #334155;
            border-top-color: #059669;
        }

        body.dark-mode .station-popup {
            background: #1e293b;
            color: #f1f5f9;
        }

        body.dark-mode .station-header {
            color: #f1f5f9;
        }

        body.dark-mode .station-info {
            color: #cbd5e1;
        }

        body.dark-mode .leaflet-popup-content-wrapper {
            background: #1e293b !important;
            color: #f1f5f9 !important;
        }

        body.dark-mode .leaflet-popup-tip {
            background: #1e293b !important;
        }

        body.dark-mode .station-popup select {
            background: #334155 !important;
            color: #f1f5f9 !important;
            border: 1px solid #475569 !important;
        }

        @media (max-width: 768px) {
            .route-info {
                right: 10px;
                left: 10px;
                top: 10px;
            }
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="search-container">
        <input type="text" class="search-box" id="searchInput" placeholder="Search EV stations..." />
        <button class="search-btn" id="searchBtn">
            <i class="fas fa-search"></i>
        </button>
    </div>

    <div class="controls">
        <button class="control-btn" id="locateBtn" data-tooltip="Find your current location">
            <i class="fas fa-crosshairs"></i>
        </button>
        <button class="control-btn" id="nearbyBtn" data-tooltip="Search for nearby EV charging stations">
            <i class="fas fa-charging-station"></i>
        </button>
        <button class="control-btn" id="listBtn" data-tooltip="Show search results in a list view">
            <i class="fas fa-list"></i>
        </button>
        <button class="control-btn" id="themeBtn" data-tooltip="Switch between dark and light mode">
            <i class="fas fa-moon"></i>
        </button>
    </div>

    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div>Searching stations...</div>
    </div>

    <div class="results-panel" id="resultsPanel">
        <div class="results-header">
            <span id="resultsTitle">EV Stations</span>
            <button class="close-btn" id="closeResults">&times;</button>
        </div>
        <div class="results-list" id="resultsList"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        class EVStationFinder {
            constructor() {
                this.map = null;
                this.userLocation = null;
                this.markers = [];
                this.userMarker = null;
                this.currentResults = [];
                this.routeLayer = null;
                this.init();
            }

            init() {
                this.initMap();
                this.bindEvents();
                this.requestLocation();
                this.initTheme();
            }

            initMap() {
                // Initialize map centered on India
                this.map = L.map('map', {
                    zoomControl: false
                }).setView([20.5937, 78.9629], 5);

                // Add tile layer
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors',
                    maxZoom: 19
                }).addTo(this.map);

                // Add zoom control to bottom right
                L.control.zoom({
                    position: 'bottomright'
                }).addTo(this.map);
            }

            bindEvents() {
                document.getElementById('searchBtn').addEventListener('click', () => this.searchStations());
                document.getElementById('searchInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.searchStations();
                });
                document.getElementById('locateBtn').addEventListener('click', () => this.requestLocation());
                document.getElementById('nearbyBtn').addEventListener('click', () => this.findNearbyStations());
                document.getElementById('listBtn').addEventListener('click', () => this.toggleResultsPanel());
                document.getElementById('closeResults').addEventListener('click', () => this.hideResultsPanel());
                document.getElementById('themeBtn').addEventListener('click', () => this.toggleTheme());
            }

            showLoading() {
                document.getElementById('loading').style.display = 'block';
            }

            hideLoading() {
                document.getElementById('loading').style.display = 'none';
            }

            requestLocation() {
                if (navigator.geolocation) {
                    this.showLoading();
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            this.userLocation = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude
                            };
                            this.updateUserMarker();
                            this.map.setView([this.userLocation.lat, this.userLocation.lng], 13);
                            this.hideLoading();
                        },
                        (error) => {
                            console.error('Location error:', error);
                            this.hideLoading();
                            alert('Could not get your location. Please enable location services.');
                        }
                    );
                } else {
                    alert('Geolocation is not supported by this browser.');
                }
            }

            updateUserMarker() {
                if (this.userMarker) {
                    this.map.removeLayer(this.userMarker);
                }

                if (this.userLocation) {
                    const userIcon = L.divIcon({
                        className: 'user-marker',
                        iconSize: [15, 15],
                        iconAnchor: [7.5, 7.5]
                    });

                    this.userMarker = L.marker([this.userLocation.lat, this.userLocation.lng], {
                        icon: userIcon
                    }).addTo(this.map);

                    this.userMarker.bindPopup('<b>Your Location</b>').openPopup();
                }
            }

            async searchStations() {
                const query = document.getElementById('searchInput').value.trim();
                if (!query) {
                    alert('Please enter a search term');
                    return;
                }

                this.showLoading();
                try {
                    const response = await fetch(`/search?query=${encodeURIComponent(query)}`);
                    const data = await response.json();
                    
                    if (data.error) {
                        throw new Error(data.error);
                    }

                    this.currentResults = data.results || [];
                    this.displayStations(this.currentResults);
                    this.updateResultsList(this.currentResults, `Search: "${query}"`);
                    
                    if (this.currentResults.length === 0) {
                        alert('No EV stations found for your search.');
                    }
                } catch (error) {
                    console.error('Search error:', error);
                    alert('Error searching stations: ' + error.message);
                } finally {
                    this.hideLoading();
                }
            }

            async findNearbyStations() {
                if (!this.userLocation) {
                    alert('Please allow location access first');
                    this.requestLocation();
                    return;
                }

                this.showLoading();
                try {
                    const response = await fetch(
                        `/ev-stations?lat=${this.userLocation.lat}&lng=${this.userLocation.lng}&radius=5000`
                    );
                    const data = await response.json();
                    
                    if (data.error) {
                        throw new Error(data.error);
                    }

                    this.currentResults = data.results || [];
                    this.displayStations(this.currentResults);
                    this.updateResultsList(this.currentResults, 'Nearby Stations');
                    
                    if (this.currentResults.length === 0) {
                        alert('No EV stations found nearby.');
                    }
                } catch (error) {
                    console.error('Nearby search error:', error);
                    alert('Error finding nearby stations: ' + error.message);
                } finally {
                    this.hideLoading();
                }
            }

            displayStations(stations) {
                // Clear existing markers
                this.markers.forEach(marker => this.map.removeLayer(marker));
                this.markers = [];

                if (stations.length === 0) return;

                const bounds = L.latLngBounds();

                stations.forEach(station => {
                    const evIcon = L.divIcon({
                        className: 'ev-marker',
                        iconSize: [20, 20],
                        iconAnchor: [10, 10]
                    });

                    const marker = L.marker([station.latitude, station.longitude], {
                        icon: evIcon
                    }).addTo(this.map);

                    // Create popup content
                    const popupContent = this.createPopupContent(station);
                    marker.bindPopup(popupContent, { maxWidth: 300 });

                    this.markers.push(marker);
                    bounds.extend([station.latitude, station.longitude]);
                });

                // Fit map to show all stations
                if (stations.length > 1) {
                    this.map.fitBounds(bounds, { padding: [20, 20] });
                } else {
                    this.map.setView([stations[0].latitude, stations[0].longitude], 15);
                }
            }

            createPopupContent(station) {
                let content = `
                    <div class="station-popup">
                        <div class="station-header">${station.name}</div>
                `;

                if (station.address) {
                    content += `<div class="station-info"><i class="fas fa-map-marker-alt"></i> ${station.address}</div>`;
                }

                if (station.rating) {
                    content += `<div class="station-info station-rating"><i class="fas fa-star"></i> ${station.rating}/5</div>`;
                }

                if (station.distance_m !== null) {
                    const distance = station.distance_m < 1000 
                        ? `${station.distance_m}m` 
                        : `${(station.distance_m / 1000).toFixed(1)}km`;
                    content += `<div class="station-info station-distance"><i class="fas fa-route"></i> ${distance} away</div>`;
                }

                if (station.estimated_time) {
                    content += `<div class="station-info"><i class="fas fa-clock"></i> ~${station.estimated_time}</div>`;
                }

                if (station.open_now !== null) {
                    const status = station.open_now ? 'Open Now' : 'Closed';
                    const statusClass = station.open_now ? 'text-success' : 'text-danger';
                    content += `<div class="station-info ${statusClass}"><i class="fas fa-clock"></i> ${status}</div>`;
                }

                if (station.phone_no) {
                    content += `<div class="station-info"><i class="fas fa-phone"></i> ${station.phone_no}</div>`;
                }

                // Add photos if available
                if (station.photo_urls && station.photo_urls.length > 0) {
                    content += '<div class="station-photos">';
                    station.photo_urls.forEach((photoUrl, index) => {
                        const photosJson = JSON.stringify(station.photo_urls).replace(/"/g, '&quot;');
                        content += `<img src="${photoUrl}" class="station-photo" onclick="openGallery('${photosJson}', ${index})" />`;
                    });
                    content += '</div>';
                }

                // Add action buttons
                content += `
                    <div class="station-actions">
                        <select id="routeType-${station.latitude}-${station.longitude}" style="padding: 6px; border-radius: 5px; border: 1px solid #ddd; margin-bottom: 8px; width: 100%;">
                            <option value="fastest">‚ö° Fastest Route</option>
                            <option value="shortest">üìè Shortest Route</option>
                            <option value="eco">üå± Eco-Friendly Route</option>
                        </select>
                        <button class="action-btn" onclick="evFinder.getDirections(${station.latitude}, ${station.longitude}, '${station.name.replace(/'/g, "\\'")}')">
                            <i class="fas fa-route"></i> Route
                        </button>
                        <button class="action-btn" onclick="window.open('https://www.google.com/maps/dir/?api=1&destination=${station.latitude},${station.longitude}', '_blank')">
                            <i class="fas fa-directions"></i> Google
                        </button>
                `;

                if (station.phone_no) {
                    content += `<button class="action-btn" onclick="window.open('tel:${station.phone_no}', '_self')">
                        <i class="fas fa-phone"></i> Call
                    </button>`;
                }

                content += `
                    </div>
                    </div>
                `;

                return content;
            }

            updateResultsList(stations, title) {
                document.getElementById('resultsTitle').textContent = `${title} (${stations.length})`;
                const resultsList = document.getElementById('resultsList');
                
                if (stations.length === 0) {
                    resultsList.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">No stations found</div>';
                    return;
                }

                resultsList.innerHTML = stations.map(station => {
                    const distance = station.distance_m !== null 
                        ? (station.distance_m < 1000 
                            ? `${station.distance_m}m` 
                            : `${(station.distance_m / 1000).toFixed(1)}km`)
                        : '';
                    
                    const rating = station.rating ? `‚≠ê ${station.rating}` : '';
                    
                    return `
                        <div class="result-item" onclick="evFinder.focusStation(${station.latitude}, ${station.longitude})">
                            <div class="result-name">${station.name}</div>
                            <div class="result-address">${station.address || 'Address not available'}</div>
                            <div class="result-meta">
                                <span>${distance}</span>
                                <span>${rating}</span>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            focusStation(lat, lng) {
                this.map.setView([lat, lng], 16);
                
                // Find and open the popup for this station
                this.markers.forEach(marker => {
                    const markerLatLng = marker.getLatLng();
                    if (Math.abs(markerLatLng.lat - lat) < 0.0001 && Math.abs(markerLatLng.lng - lng) < 0.0001) {
                        marker.openPopup();
                    }
                });
                
                this.hideResultsPanel();
            }

            toggleResultsPanel() {
                const panel = document.getElementById('resultsPanel');
                if (panel.style.display === 'flex') {
                    this.hideResultsPanel();
                } else {
                    this.showResultsPanel();
                }
            }

            showResultsPanel() {
                document.getElementById('resultsPanel').style.display = 'flex';
                document.getElementById('listBtn').classList.add('active');
            }

            hideResultsPanel() {
                document.getElementById('resultsPanel').style.display = 'none';
                document.getElementById('listBtn').classList.remove('active');
            }

            async getDirections(destLat, destLng, stationName) {
                if (!this.userLocation) {
                    alert('Please allow location access first');
                    this.requestLocation();
                    return;
                }

                // Get selected route type
                const routeTypeSelect = document.getElementById(`routeType-${destLat}-${destLng}`);
                const routeType = routeTypeSelect ? routeTypeSelect.value : 'fastest';

                this.showLoading();
                try {
                    const response = await fetch(
                        `/directions?origin_lat=${this.userLocation.lat}&origin_lng=${this.userLocation.lng}&dest_lat=${destLat}&dest_lng=${destLng}&route_type=${routeType}`
                    );
                    const data = await response.json();
                    
                    if (data.error) {
                        throw new Error(data.error);
                    }

                    // Add station name to route data
                    data.station_name = stationName || 'EV Charging Station';
                    
                    this.displayRoute(data, routeType);
                    this.showRouteInfo(data);
                } catch (error) {
                    console.error('Directions error:', error);
                    alert('Error getting directions: ' + error.message);
                } finally {
                    this.hideLoading();
                }
            }

            displayRoute(routeData, routeType) {
                // Remove existing route
                if (this.routeLayer) {
                    this.map.removeLayer(this.routeLayer);
                }

                // Route colors based on type
                const routeColors = {
                    'fastest': '#FF5722',    // Orange-red for fastest
                    'shortest': '#2196F3',   // Blue for shortest
                    'eco': '#4CAF50'         // Green for eco-friendly
                };

                // Add new route
                if (routeData.route_points && routeData.route_points.length > 0) {
                    this.routeLayer = L.polyline(routeData.route_points, {
                        color: routeColors[routeType] || '#4CAF50',
                        weight: 5,
                        opacity: 0.8
                    }).addTo(this.map);

                    // Fit map to show entire route
                    this.map.fitBounds(this.routeLayer.getBounds(), { padding: [20, 20] });
                }
            }

            showRouteInfo(routeData) {
                // Remove any existing route info panels first
                const existingInfos = document.querySelectorAll('.route-info');
                existingInfos.forEach(info => info.remove());
                
                const routeTypeConfig = {
                    'Fastest': { color: '#FF5722', bgColor: 'rgba(255, 87, 34, 0.08)' },
                    'Shortest': { color: '#2196F3', bgColor: 'rgba(33, 150, 243, 0.08)' },
                    'Eco': { color: '#4CAF50', bgColor: 'rgba(76, 175, 80, 0.08)' }
                };
                
                const config = routeTypeConfig[routeData.route_type] || routeTypeConfig['Fastest'];
                
                const routeInfo = `
                    <div class="route-info-card" style="
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        width: 360px;
                        background: #ffffff;
                        border-radius: 16px;
                        box-shadow: 0 8px 32px rgba(0,0,0,0.12);
                        border: 1px solid rgba(0,0,0,0.06);
                        z-index: 1001;
                        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                        overflow: hidden;
                        animation: slideInRight 0.3s ease-out;
                    ">
                        <!-- Header -->
                        <div style="
                            background: ${config.color};
                            color: white;
                            padding: 20px 24px;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                        ">
                            <div style="
                                font-weight: 600;
                                font-size: 18px;
                                letter-spacing: 0.3px;
                            ">
                                ${routeData.route_type} Route
                            </div>
                            <button onclick="evFinder.clearRoute()" style="
                                background: rgba(255,255,255,0.2);
                                border: none;
                                border-radius: 8px;
                                width: 36px;
                                height: 36px;
                                color: white;
                                font-size: 20px;
                                cursor: pointer;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                transition: all 0.2s ease;
                                font-weight: 300;
                            " onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                                √ó
                            </button>
                        </div>
                        
                        <!-- Content -->
                        <div style="padding: 24px;">
                            <!-- Journey Summary -->
                            <div style="
                                display: grid;
                                grid-template-columns: 1fr 1fr;
                                gap: 20px;
                                margin-bottom: 24px;
                            ">
                                <div style="
                                    background: ${config.bgColor};
                                    padding: 20px;
                                    border-radius: 12px;
                                    text-align: center;
                                    border: 1px solid ${config.color}15;
                                ">
                                    <div style="
                                        font-size: 28px;
                                        font-weight: 700;
                                        color: ${config.color};
                                        margin-bottom: 6px;
                                        line-height: 1;
                                    ">
                                        ${routeData.distance}
                                    </div>
                                    <div style="
                                        font-size: 13px;
                                        color: #666;
                                        font-weight: 600;
                                        text-transform: uppercase;
                                        letter-spacing: 0.8px;
                                    ">
                                        Distance
                                    </div>
                                </div>
                                
                                <div style="
                                    background: ${config.bgColor};
                                    padding: 20px;
                                    border-radius: 12px;
                                    text-align: center;
                                    border: 1px solid ${config.color}15;
                                ">
                                    <div style="
                                        font-size: 28px;
                                        font-weight: 700;
                                        color: ${config.color};
                                        margin-bottom: 6px;
                                        line-height: 1;
                                    ">
                                        ${routeData.duration}
                                    </div>
                                    <div style="
                                        font-size: 13px;
                                        color: #666;
                                        font-weight: 600;
                                        text-transform: uppercase;
                                        letter-spacing: 0.8px;
                                    ">
                                        Estimated Time
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Route Benefits -->
                            ${routeData.benefits ? `
                                <div style="
                                    background: linear-gradient(135deg, #f8f9ff 0%, #f0f4ff 100%);
                                    padding: 18px;
                                    border-radius: 12px;
                                    margin-bottom: 24px;
                                    border-left: 4px solid ${config.color};
                                ">
                                    <div style="
                                        font-size: 14px;
                                        color: #2c3e50;
                                        line-height: 1.6;
                                        font-weight: 500;
                                    ">
                                        ${routeData.benefits}
                                    </div>
                                </div>
                            ` : ''}
                            
                            <!-- Journey Information -->
                            <div style="
                                background: #f8f9fa;
                                padding: 20px;
                                border-radius: 12px;
                                margin-bottom: 24px;
                            ">
                                <div style="
                                    font-size: 12px;
                                    color: #666;
                                    font-weight: 700;
                                    text-transform: uppercase;
                                    letter-spacing: 1px;
                                    margin-bottom: 16px;
                                ">
                                    Journey Information
                                </div>
                                
                                <div style="margin-bottom: 16px;">
                                    <div style="
                                        display: flex;
                                        align-items: center;
                                        gap: 10px;
                                        margin-bottom: 6px;
                                    ">
                                        <div style="
                                            width: 10px;
                                            height: 10px;
                                            background: #4CAF50;
                                            border-radius: 50%;
                                            flex-shrink: 0;
                                        "></div>
                                        <span style="
                                            font-size: 13px;
                                            font-weight: 600;
                                            color: #4CAF50;
                                        ">From</span>
                                    </div>
                                    <div style="
                                        font-size: 13px;
                                        color: #555;
                                        margin-left: 20px;
                                        background: #fff;
                                        padding: 8px 12px;
                                        border-radius: 6px;
                                        border: 1px solid #e0e0e0;
                                    ">
                                        Your Current Location
                                    </div>
                                </div>
                                
                                <div>
                                    <div style="
                                        display: flex;
                                        align-items: center;
                                        gap: 10px;
                                        margin-bottom: 6px;
                                    ">
                                        <div style="
                                            width: 10px;
                                            height: 10px;
                                            background: #f44336;
                                            border-radius: 50%;
                                            flex-shrink: 0;
                                        "></div>
                                        <span style="
                                            font-size: 13px;
                                            font-weight: 600;
                                            color: #f44336;
                                        ">To</span>
                                    </div>
                                    <div style="
                                        font-size: 13px;
                                        color: #555;
                                        margin-left: 20px;
                                        background: #fff;
                                        padding: 8px 12px;
                                        border-radius: 6px;
                                        border: 1px solid #e0e0e0;
                                    ">
                                        ${routeData.station_name || 'EV Charging Station'}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Action Button -->
                            <button onclick="evFinder.clearRoute()" style="
                                width: 100%;
                                padding: 16px;
                                background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
                                color: white;
                                border: none;
                                border-radius: 12px;
                                cursor: pointer;
                                font-weight: 600;
                                font-size: 15px;
                                transition: all 0.3s ease;
                                letter-spacing: 0.3px;
                            " onmouseover="
                                this.style.transform='translateY(-2px)';
                                this.style.boxShadow='0 8px 25px rgba(108, 117, 125, 0.3)';
                            " onmouseout="
                                this.style.transform='translateY(0)';
                                this.style.boxShadow='none';
                            ">
                                Close Route
                            </button>
                        </div>
                    </div>
                    
                    <style>
                        @keyframes slideInRight {
                            from {
                                transform: translateX(100%);
                                opacity: 0;
                            }
                            to {
                                transform: translateX(0);
                                opacity: 1;
                            }
                        }
                        
                        @media (max-width: 768px) {
                            .route-info-card {
                                position: fixed !important;
                                top: 10px !important;
                                left: 10px !important;
                                right: 10px !important;
                                width: auto !important;
                            }
                        }
                    </style>
                `;
                
                // Add new route info
                const routeInfoDiv = document.createElement('div');
                routeInfoDiv.className = 'route-info';
                routeInfoDiv.innerHTML = routeInfo;
                document.body.appendChild(routeInfoDiv);
            }

            clearRoute() {
                if (this.routeLayer) {
                    this.map.removeLayer(this.routeLayer);
                    this.routeLayer = null;
                }
                
                const routeInfo = document.querySelector('.route-info');
                if (routeInfo) {
                    routeInfo.remove();
                }
                
                // Fit map to show all stations again
                if (this.markers.length > 0) {
                    const bounds = L.latLngBounds();
                    this.markers.forEach(marker => bounds.extend(marker.getLatLng()));
                    if (this.userLocation) {
                        bounds.extend([this.userLocation.lat, this.userLocation.lng]);
                    }
                    this.map.fitBounds(bounds, { padding: [20, 20] });
                }
            }

            toggleTheme() {
                const body = document.body;
                const themeBtn = document.getElementById('themeBtn');
                const icon = themeBtn.querySelector('i');
                
                body.classList.toggle('dark-mode');
                
                if (body.classList.contains('dark-mode')) {
                    icon.className = 'fas fa-sun';
                    localStorage.setItem('theme', 'dark');
                } else {
                    icon.className = 'fas fa-moon';
                    localStorage.setItem('theme', 'light');
                }
            }

            initTheme() {
                const savedTheme = localStorage.getItem('theme');
                const themeBtn = document.getElementById('themeBtn');
                const icon = themeBtn.querySelector('i');
                
                if (savedTheme === 'dark') {
                    document.body.classList.add('dark-mode');
                    icon.className = 'fas fa-sun';
                } else {
                    icon.className = 'fas fa-moon';
                }
            }
        }

        // Initialize the app
        const evFinder = new EVStationFinder();

        // Make it globally accessible for onclick events
        window.evFinder = evFinder;

        // Simple gallery with working navigation
        window.currentPhotos = [];
        window.currentPhotoIndex = 0;
        
        window.openGallery = function(photosJson, currentIndex) {
            window.currentPhotos = JSON.parse(photosJson.replace(/&quot;/g, '"'));
            window.currentPhotoIndex = currentIndex;
            showCurrentPhoto();
        };
        
        window.showCurrentPhoto = function() {
            const photos = window.currentPhotos;
            const currentIndex = window.currentPhotoIndex;
            
            // Remove existing modal
            const existing = document.querySelector('.photo-modal');
            if (existing) existing.remove();
            
            const modal = document.createElement('div');
            modal.className = 'photo-modal';
            modal.style.cssText = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.95);z-index:2000;display:flex;align-items:center;justify-content:center;';
            
            modal.innerHTML = `
                <div style="position:relative;width:90vw;height:90vh;display:flex;align-items:center;justify-content:center;">
                    <img src="${photos[currentIndex]}" style="max-width:100%;max-height:100%;object-fit:contain;border-radius:8px;">
                    <button onclick="document.querySelector('.photo-modal').remove()" style="position:absolute;top:20px;right:20px;background:rgba(255,255,255,0.9);border:none;width:50px;height:50px;border-radius:50%;font-size:24px;cursor:pointer;display:flex;align-items:center;justify-content:center;">√ó</button>
                    ${photos.length > 1 ? `
                        <button onclick="window.prevPhoto()" style="position:absolute;left:20px;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.9);border:none;width:50px;height:50px;border-radius:50%;font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;">‚Äπ</button>
                        <button onclick="window.nextPhoto()" style="position:absolute;right:20px;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.9);border:none;width:50px;height:50px;border-radius:50%;font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;">‚Ä∫</button>
                        <div style="position:absolute;bottom:20px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.7);color:white;padding:8px 16px;border-radius:20px;font-size:14px;">${currentIndex + 1} of ${photos.length}</div>
                    ` : ''}
                </div>
            `;
            
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
            document.body.appendChild(modal);
        };
        
        window.nextPhoto = function() {
            window.currentPhotoIndex = window.currentPhotoIndex < window.currentPhotos.length - 1 ? window.currentPhotoIndex + 1 : 0;
            showCurrentPhoto();
        };
        
        window.prevPhoto = function() {
            window.currentPhotoIndex = window.currentPhotoIndex > 0 ? window.currentPhotoIndex - 1 : window.currentPhotos.length - 1;
            showCurrentPhoto();
        };
    </script>
</body>
</html>